<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">
    <script src="http://assets.diandong.com/mobile/live/build/flexible.js"></script>

    <script type="text/javascript" src="http://assets.diandong.com/mobile/js/jquery.min.js"></script>
   <!--  <script type="text/javascript" src="/static/js/laydate/laydate.js"></script>  -->
    <script type="text/javascript" src="source/js/post/exif.js"></script>
</head>

<body>

    <div class="wrap clearfix">
        <a href="/live/detail/22/" class="back-button">返回</a>
    </div>

    <div class="">
        <form action="/live/savePub/" method="post" onsubmit="return ckform()">
            <input type="hidden" name="liveId" value="22" />
            <input type="hidden" name="pid" value="" />

            <div class="edit-item edit-item-text">
                <header class="edit-item-header">
                    <h3>推文</h3>
                </header>
                <div class="edit-item-content">
                    <textarea name="summary" id="summary" placeholder="活动推文"></textarea>
                </div>
            </div>

            <div class="edit-item edit-item-location">
                <header class="edit-item-header">
                    <h3>地点</h3>
                </header>
                <div class="edit-item-content">
                    <input type="text" class="address" name="address" id="address" value="" placeholder="活动地点">
                </div>
            </div>

            <div class="edit-item edit-item-photo">
                <header class="edit-item-header">
                    <h3>图片</h3>
                </header>
            </div>

            <div class="upload" id="upload_img">
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
                <div class="upload-item">
                    <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">
                    <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">
                    <div id="" class="cell cell_1">
                        <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>
                        
                    </div>
                </div>
            </div>

            <div class="edit-item edit-item-top">
                <div class="edit-item-content">
                    <label for="ontop"><input type="checkbox" name="isTop" id="isTop" value="1" > 置顶</label>
                    <label for="ontop" style="margin-left:2rem;">发布时间 : <input type="text" name="createTime" id="createTime" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm'})" value=""/ ></label>
                </div>
            </div>

            <div class="edit-item edit-item-submit">
                <input type="submit" value="提交">
            </div>

        </form>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>
    <!-- <script src="../build/edit.debug.js"></script> -->
    <script src="http://assets.diandong.com/mobile/live/build/edit.debug.js"></script>
<script type="text/javascript">
/*var liveId = '22';
function ckform() {
    var summary = document.getElementById('summary').value;
    if (summary=='' || summary.length<2) {
        alert('请输入推文内容, 不少于2个字');
        return false;
    }

    return true;
}

function loadUpload() {
    var ispic = $('input[name="isPic"]:checked').val();
    
}

function addPic() {
    if ($('input[name="pics[]"]').length<9) {
        var html = '';
        html += '<div class="upload-item">';
        html += '            <input type="file" name="headpic[]" class="headpicinput_1" id="headpicinput_1" style="display: none;" onchange="UpLoad(this)">';
        html += '            <input type="hidden" id="imgUrl_1" class="imgUrl" name="pics[]" value="">';
        html += '            <div id="" class="cell cell_1">';
        html += '                <a href="javascript:void(0);"><img src="http://i1.dd-img.com/assets/image/1495764543-95352fde674ead19-200w-200h.png" id="preViewImg_1" class="preViewImg"></a>';
        html += '                ';
        html += '            </div>';
        html += '        </div>';
        $('#image_div').append('<input type="text" name="pics[]" id="pics[]" value="" style="width:100%" />');
    } else {
        alert('最多可以上传9张图片');
    }
}*/

$(function(){
  /*  $('input[name="isPic"]').bind('click', loadUpload);
    $('#addBtn').bind('click', addPic);*/
    //监听上传
    $('.upload-item a').bind('click', function(){
        $(this).parent().parent().find('input[name="headpic[]"]').click();
    })
});





 function UpLoad(e) {
    var f = e.files[0];

    fileType = f.type;
    console.log(f);
    var parent = $(e).parents('.upload-item');

    var imgUrlInput = parent.find('.imgUrl');
    var preViewImg = parent.find('.preViewImg');
    var imgUrl = parent.find('.imgUrl');
    var Orientation = '';

    if (/image\/\w+/.test(fileType)) {
        var fileReader = new FileReader();
        EXIF.getData(f, function() {  
           // alert(EXIF.pretty(this));  
            EXIF.getAllTags(this);   
            //alert(EXIF.getTag(this, 'Orientation'));   
            Orientation = EXIF.getTag(this, 'Orientation');  
        });  

        fileReader.readAsDataURL(f);

        fileReader.onload = function(event) {
            var result = event.target.result; //返回的dataURL
            // var image = new Image();

            // image.src = result;
            //若图片大小大于1M，压缩后再上传，否则直接上传

            var maxW = 1200;
            var maxH = 1000;
            var rat = maxW/maxH;

            var image = new Image();  
            image.src = result;//;e.target.result;  
            image.onload = function() {  
                var expectWidth = this.naturalWidth;  
                var expectHeight = this.naturalHeight;  
                  
                if (this.naturalWidth > this.naturalHeight && this.naturalWidth > maxW) {  
                    expectWidth = maxW;  
                    expectHeight = expectWidth * this.naturalHeight / this.naturalWidth;  
                } else if (this.naturalHeight > this.naturalWidth && this.naturalHeight > maxH) {  
                    expectHeight = maxH;  
                    expectWidth = expectHeight * this.naturalWidth / this.naturalHeight;  
                }  
                var canvas = document.createElement("canvas");  
                var ctx = canvas.getContext("2d");  
                canvas.width = expectWidth;  
                canvas.height = expectHeight;  
                //console.log(canvas.width+':'+canvas.height);
                ctx.drawImage(this, 0, 0, expectWidth, expectHeight);  
                var base64 = null;  
                //修复ios  
                if (navigator.userAgent.match(/iphone/i)) {  
                    //console.log('iphone');  
                    //alert(expectWidth + ',' + expectHeight);  
                    //如果方向角不为1，都需要进行旋转 added by lzk  
                    if(Orientation != "" && Orientation != 1){  
                        //alert('旋转处理');  
                        switch(Orientation){  
                            case 6://需要顺时针（向左）90度旋转  
                                //alert('需要顺时针（向左）90度旋转');  
                                rotateImg(this,'left',canvas);  
                                break;  
                            case 8://需要逆时针（向右）90度旋转  
                                //alert('需要顺时针（向右）90度旋转');  
                                rotateImg(this,'right',canvas);  
                                break;  
                            case 3://需要180度旋转  
                                //alert('需要180度旋转');  
                                rotateImg(this,'right',canvas);//转两次  
                                rotateImg(this,'right',canvas);  
                                break;  
                        }         
                    }  
                    base64 = canvas.toDataURL(fileType, 0.8);  
                }else if (navigator.userAgent.match(/Android/i)) {// 修复android  
                    var canvas = document.getElementById("canvas");
                    canvas.width = this.width;
                    canvas.height = this.height; //计算等比缩小后图片宽高
                    var ctx = canvas.getContext('2d');
                    var expectHeight = this.naturalHeight; 
                    console.log(canvas.width+'/'+canvas.height);
                    //等比压缩
                    if (canvas.width/canvas.height>rat) {
                        if (canvas.width>maxW) {
                            canvas.width = maxW;
                            canvas.height = parseInt((canvas.height*maxW)/this.width);
                        }
                    } else {
                        if (canvas.height>maxH) {
                                canvas.height = maxH;
                                canvas.width = parseInt((canvas.width*maxH)/this.height);
                            } else {
                                
                            }
                    }
                    console.log(canvas.width+'=>'+canvas.height);
                    ctx.drawImage(this, 0, 0, canvas.width, canvas.height);
                    base64 = canvas.toDataURL(fileType, 0.8); //重新生成图片
                    // var encoder = new JPEGEncoder();  
                    // base64 = encoder.encode(ctx.getImageData(0, 0, expectWidth, expectHeight), 80);  
                }else{  
                    //alert(Orientation);  
                    if(Orientation != "" && Orientation != 1){  
                        //alert('旋转处理');  
                        switch(Orientation){  
                            case 6://需要顺时针（向左）90度旋转  
                                //alert('需要顺时针（向左）90度旋转');  
                                rotateImg(this,'left',canvas);  
                                break;  
                            case 8://需要逆时针（向右）90度旋转  
                                //alert('需要顺时针（向右）90度旋转');  
                                rotateImg(this,'right',canvas);  
                                break;  
                            case 3://需要180度旋转  
                                //alert('需要180度旋转');  
                                rotateImg(this,'right',canvas);//转两次  
                                rotateImg(this,'right',canvas);  
                                break;  
                        }         
                    }  
                      
                    base64 = canvas.toDataURL(fileType, 0.8);  

                }  
                var postData = base64.replace("data:" + fileType + ";base64,", '');
                // 图片赋值
                preViewImg.attr("src", base64);  

                $.post('/live/ajax/', {opt:'upload', base64Img:postData, fileType:fileType, rnd:Math.random()}, function(result){
                    if (result.match("^\{(.+:.+,*){1,}\}$")) {
                        result = $.parseJSON(result);
                        if (result.code == 200) {
                            imgUrlInput.val(result.data);
                            //preViewImg.attr('src', result.data);
                        } else {
                            alert(result.msg);
                        }
                    } else {
                        alert('上传出错, 返回格式不正确');
                    }
                });
            };  

        }
    } else {
        alert("请选择图片");
    }
}




//对图片旋转处理 added by lzk  
function rotateImg(img, direction,canvas) {    
        //alert(img);  
        //最小与最大旋转方向，图片旋转4次后回到原方向    
        var min_step = 0;    
        var max_step = 3;    
        //var img = document.getElementById(pid);    
        if (img == null)return;    
        //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
        var height = img.height;    
        var width = img.width;    
        //var step = img.getAttribute('step');    
        var step = 2;    
        if (step == null) {    
            step = min_step;    
        }    
        if (direction == 'right') {    
            step++;    
            //旋转到原位置，即超过最大值    
            step > max_step && (step = min_step);    
        } else {    
            step--;    
            step < min_step && (step = max_step);    
        }    
        //img.setAttribute('step', step);    
        /*var canvas = document.getElementById('pic_' + pid);   
        if (canvas == null) {   
            img.style.display = 'none';   
            canvas = document.createElement('canvas');   
            canvas.setAttribute('id', 'pic_' + pid);   
            img.parentNode.appendChild(canvas);   
        }  */  
        //旋转角度以弧度值为参数    
        var degree = step * 90 * Math.PI / 180;    
        var ctx = canvas.getContext('2d');    
        switch (step) {    
            case 0:    
                canvas.width = width;    
                canvas.height = height;    
                ctx.drawImage(img, 0, 0);    
                break;    
            case 1:    
                canvas.width = height;    
                canvas.height = width;    
                ctx.rotate(degree);    
                ctx.drawImage(img, 0, -height);    
                break;    
            case 2:    
                canvas.width = width;    
                canvas.height = height;    
                ctx.rotate(degree);    
                ctx.drawImage(img, -width, -height);    
                break;    
            case 3:    
                canvas.width = height;    
                canvas.height = width;    
                ctx.rotate(degree);    
                ctx.drawImage(img, -width, 0);    
                break;    
        }    
    }    
</script>
</body>

</html>